---
import PicksLayout from '../../layouts/PicksLayout.astro';
import PicksFooter from '../../components/picks/PicksFooter.astro';
import PickCard from '../../components/picks/PickCard.astro';
import { categoryLabels, picks } from '../../data/picks';
import type { PickCategoryKey } from '../../data/picks';

const categories = Object.entries(categoryLabels) as [PickCategoryKey, string][];
const featuredCount = picks.filter((pick) => pick.featured).length;
---

<PicksLayout
  title="Picks | CarlosCondor"
  description="Catálogo de productos recomendados por CarlosCondor."
>
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100" data-purpose="main-nav">
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-8">
        <a class="text-xl font-bold tracking-tighter text-primary" href="/">CARLOSCONDOR</a>
        <div class="hidden md:flex items-center gap-6 text-sm font-medium text-gray-500">
          <a class="hover:text-black transition-colors" href="/">Inicio</a>
          <a class="hover:text-black transition-colors text-black" href="/picks">Picks</a>
          <a class="hover:text-black transition-colors" href="https://CarlosCondor.github.io/">Blog</a>
        </div>
      </div>
    </div>
  </nav>

  <main>
    <section class="max-w-4xl mx-auto px-6 pt-10 pb-8 md:pt-20 md:pb-12 text-center" data-purpose="hero-section">
      <h1 class="text-3xl md:text-5xl font-bold tracking-tight text-gray-900 mb-4 md:mb-6 leading-tight">
        Productos que recomiendo
      </h1>
      <p class="text-base md:text-lg text-gray-500 mb-2 max-w-2xl mx-auto">
        Un catálogo de herramientas, objetos y accesorios que considero útiles en mi trabajo y vida diaria.
      </p>
    </section>

    <section class="bg-[#f7f7f5]/90 backdrop-blur-md mb-10 sticky top-16 z-40" data-purpose="filter-bar">
      <div class="max-w-7xl mx-auto px-6 py-3 sm:flex sm:items-center sm:justify-between sm:gap-4">
        <div class="overflow-x-auto no-scrollbar">
          <div class="flex items-center gap-2 min-w-max py-1">
            <button
              type="button"
              class="js-filter-btn filter-chip"
              data-filter-btn
              data-filter="all"
              aria-pressed="true"
            >
              Todos
            </button>
            {categories.map(([key, label]) => (
              <button
                type="button"
                class="js-filter-btn filter-chip"
                data-filter-btn
                data-filter={key}
                aria-pressed="false"
              >
                {label}
              </button>
            ))}
          </div>
        </div>
        <span class="filter-stats-chip hidden sm:block text-xs font-medium text-gray-400 whitespace-nowrap" data-filter-stats>
          {picks.length} productos · {featuredCount} destacados
        </span>
      </div>
    </section>

    <section class="max-w-7xl mx-auto px-6 pb-20" data-purpose="catalog-grid">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" data-picks-grid>
        {picks.map((product) => (
          <PickCard product={product} />
        ))}
      </div>
      <div class="hidden mt-12 text-center" data-empty-state>
        <p class="text-sm text-gray-500">
          No hay productos en esta categoría todavía.
        </p>
      </div>
      <div class="flex justify-center mt-16">
        <a class="px-8 py-3 border border-gray-200 rounded-custom text-sm font-semibold text-gray-900 hover:bg-gray-50 transition-colors" href="#top">
          Volver arriba
        </a>
      </div>
    </section>

    <PicksFooter />
  </main>

  <script>
    const buttons = Array.from(
      document.querySelectorAll('[data-filter-btn]'),
    );
    const cards = Array.from(
      document.querySelectorAll('[data-pick-card]'),
    );
    const grid = document.querySelector('[data-picks-grid]');
    const VALID_FILTERS = new Set(
      buttons.map((button) => button.dataset.filter).filter(Boolean),
    );
    const stats = document.querySelector('[data-filter-stats]');
    const emptyState = document.querySelector('[data-empty-state]');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let currentFilter = 'all';

    const updateStats = (visibleCards) => {
      if (!stats) return;
      const featuredVisible = visibleCards.filter(
        (card) => card.dataset.featured === 'true',
      ).length;
      stats.textContent = `${visibleCards.length} producto${visibleCards.length === 1 ? '' : 's'} · ${featuredVisible} destacado${featuredVisible === 1 ? '' : 's'}`;
    };

    const setButtonState = (activeFilter) => {
      buttons.forEach((button) => {
        const isActive = button.dataset.filter === activeFilter;
        button.setAttribute('aria-pressed', String(isActive));
      });
    };

    const animateVisibleCards = (visibleCards) => {
      if (prefersReducedMotion) return;

      if (grid) {
        grid.classList.remove('grid-filter-refresh');
        void grid.offsetWidth;
        grid.classList.add('grid-filter-refresh');
      }

      visibleCards.forEach((card, index) => {
        card.classList.remove('pick-card-filter-enter');
        card.style.removeProperty('--filter-stagger-delay');
        void card.offsetWidth;
        card.style.setProperty('--filter-stagger-delay', `${Math.min(index, 8) * 35}ms`);
        card.classList.add('pick-card-filter-enter');
        card.addEventListener(
          'animationend',
          () => {
            card.classList.remove('pick-card-filter-enter');
            card.style.removeProperty('--filter-stagger-delay');
          },
          { once: true },
        );
      });
    };

    const syncUrl = (filter) => {
      const url = new URL(window.location.href);
      if (filter === 'all') {
        url.searchParams.delete('category');
      } else {
        url.searchParams.set('category', filter);
      }
      window.history.replaceState({}, '', url);
    };

    const applyFilter = (filter, shouldSyncUrl = true) => {
      const activeFilter = VALID_FILTERS.has(filter) ? filter : 'all';
      const visibleCards = [];
      const changedFilter = activeFilter !== currentFilter;

      cards.forEach((card) => {
        const matches =
          activeFilter === 'all' || card.dataset.category === activeFilter;
        card.classList.toggle('hidden', !matches);
        if (matches) visibleCards.push(card);
      });

      if (emptyState) {
        emptyState.classList.toggle('hidden', visibleCards.length > 0);
      }

      setButtonState(activeFilter);
      updateStats(visibleCards);
      if (changedFilter) {
        animateVisibleCards(visibleCards);
      }
      if (shouldSyncUrl) syncUrl(activeFilter);
      currentFilter = activeFilter;
    };

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        applyFilter(button.dataset.filter ?? 'all');
      });
    });

    const initialFilter = new URLSearchParams(window.location.search).get('category') ?? 'all';
    applyFilter(initialFilter, false);
  </script>

  <style is:global>
    .filter-chip {
      border-radius: 9999px;
      padding: 0.45rem 1rem;
      font-size: 0.82rem;
      line-height: 1;
      font-weight: 500;
      color: #6b7280;
      white-space: nowrap;
      border: 1px solid rgba(17, 24, 39, 0.1);
      background: rgba(243, 244, 246, 0.7);
      transition:
        background-color 0.15s ease,
        color 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease;
    }

    .filter-chip:hover {
      color: #111827;
      background-color: rgba(229, 231, 235, 0.9);
      border-color: rgba(17, 24, 39, 0.15);
    }

    .filter-chip[aria-pressed='true'] {
      color: #111827;
      background-color: #fff;
      border-color: rgba(17, 24, 39, 0.22);
      font-weight: 600;
      box-shadow: 0 1px 4px rgba(17, 24, 39, 0.08);
    }

    .filter-chip:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1);
    }

    .filter-stats-chip {
      letter-spacing: 0.01em;
    }

    .pick-card-filter-enter {
      animation: pick-card-filter-enter 0.38s cubic-bezier(0.2, 0.8, 0.2, 1) both;
      animation-delay: var(--filter-stagger-delay, 0ms);
    }

    .grid-filter-refresh {
      animation: grid-filter-refresh 0.2s ease;
    }

    @keyframes pick-card-filter-enter {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.99);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes grid-filter-refresh {
      from {
        opacity: 0.72;
      }
      to {
        opacity: 1;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .pick-card-filter-enter,
      .grid-filter-refresh {
        animation: none !important;
      }
    }
  </style>
</PicksLayout>
